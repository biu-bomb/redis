# 使用场景

当一个哈希键只包含少量键值对，并且每个键值对的键和值都是小整数值或者短字符串，``Redis``就采用压缩列表作底层实现。

# 结构组成

![image-20210505122559525](/Users/godme/Library/Application Support/typora-user-images/image-20210505122559525.png)

| field       | type         | len(byte)   | description                                                  |
| ----------- | ------------ | ----------- | ------------------------------------------------------------ |
| ``zlbytes`` | ``uint32_t`` | 4           | 记录压缩列表使用内存总数<br />内存重分配和计算``zlend``时候使用 |
| ``zltail``  | ``uint32_t`` | 4           | 记录尾节点到头结点的间隔字节数                               |
| ``zllen``   | ``uint16_t`` | 2           | 记录压缩列表元素节点个数<br />小于``UINT16_MAX（655536）``准确<br />等于``UINT16_MAX``需要遍历才能准确得知 |
| ``entryX``  | ``unknown``  | ``unknown`` | 每个节点大小取决于保存内容                                   |
| ``zlend``   | ``uint8_t``  | 1           | ``oxFF``，标记压缩列表末端                                   |

## 节点结构

![image-20210505123324618](/Users/godme/Library/Application Support/typora-user-images/image-20210505123324618.png)

| field                     | len         | descirption                                                  |
| ------------------------- | ----------- | ------------------------------------------------------------ |
| ``previous_entry_length`` | ``1or5``    | 表示上一个``entry``的长度<br />当长度小于254，使用一个字节<br />当长度大于等于254，使用五个字节：首个字节尾``0xFE``，剩余四个字节表示长度 |
| ``encoding``              | 1、2、5     | 首位表示内容，后续标识长度，详情见后                         |
| ``content``               | ``unknown`` | 具体存储数据内容，类型和长度由``encoding``标识               |

### 编码格式

- 字节数组

| prefix | length(byte) | content_length   |
| ------ | ------------ | ---------------- |
| ``00`` | ``1``        | $[0, 63]$        |
| ``01`` | ``2``        | $[0,16383]$      |
| ``10`` | ``5``        | $[0,4294967295]$ |

- 整数编码

| prefix       | length(byte) | content                                  |
| ------------ | ------------ | ---------------------------------------- |
| ``11000000`` | 1            | ``int16_t``                              |
| ``11010000`` | 1            | ``int32_t``                              |
| ``11100000`` | 1            | ``int64_t``                              |
| ``11110000`` | 1            | 24位有符号                               |
| ``11111110`` | 1            | 8位有符号                                |
| ``1111xxxx`` | 1            | ``xxxx``即为数据$[0,12]$,无需``content`` |

# 连锁更新

## 更新时机

因为使用的是指针而非数组，会影响到其他元素更新的因素一般在``previous_entry_length``字段

| operation | effect                                                       |
| --------- | ------------------------------------------------------------ |
| 插入      | 因为``previous_entry_length``记录的上一个节点的长度，但是归属于后续的节点<br />如果插入的元素相较于原来的元素变长或者缩短(254)，后续长度记录所占的空间会增大或者缩小<br />从而引起后续节点的连锁更新 |
| 删除      | 同上                                                         |

## 更新操作

将``previous_entry_length``长度更新为上一个元素长度的值，占据``1``或者``5``个字节。依次检查并向后传播。

> 如果更新前后该字段所占空间不变，则无需向后传播。

## 更新影响

连锁更新最坏需要进行``N``次操作，每次操作复杂度最坏``O(N)``，整体最坏复杂度为$O(N^2)$。

但是需要

- 连续节点长度为$[250,253]$
- 超多元素

一般现实场景很难满足，因此平均复杂度仅为$O(N)$，请放心食用。

# 压缩列表のAPI

| method                 | description | O                                                            |
| ---------------------- | ----------- | ------------------------------------------------------------ |
| ``ziplistNew``         | 创建        | $O(1)$                                                       |
| ``ziplistPush``        | 添加        | 平均$O(N)$，最坏$O(N^2)$                                     |
| ``ziplistInsert``      | 插入        | 平均$O(N)$，最坏$O(N^2)$                                     |
| ``ziplistIndex``       | 获取        | $O(N)$                                                       |
| ``ziplistFind``        | 查询        | 元素值可能是数组，对比复杂度为$O(N)$<br />全局查询就为$O(N^2)$ |
| ``ziplistNext``        | 下一个      | $O(1)$                                                       |
| ``ziplistPrev``        | 上一个      | $O(1)$                                                       |
| ``ziplistGet``         | 当前值      | $O(1)$                                                       |
| ``ziplistDelete``      | 删除        | 平均$O(N)$，最坏$O(N^2)$                                     |
| ``ziplistDeleteRange`` | 连续删除    | 平均$O(N)$，最坏$O(N^2)$                                     |
| ``ziplistBlobLen``     | 字节长度    | $O(1)$                                                       |
| ``ziplistLen``         | 节点个数    | $\left\{\begin{matrix}O(1) & len \lt 65535 \\ O(N) & len \ge 65535\end{matrix}\right.$ |

