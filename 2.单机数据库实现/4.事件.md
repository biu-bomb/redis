# 事件管理

| event    | description |
| -------- | ----------- |
| 时间事件 | 定时任务    |
| 文件事件 | 通信任务    |

# 文件事件

## 处理结构

==标准reactor模型==

![image-20210508175021375](C:\Users\wenlong.guo\AppData\Roaming\Typora\typora-user-images\image-20210508175021375.png)

## 多路复用

==统一多路复用接口==

![image-20210508175113515](C:\Users\wenlong.guo\AppData\Roaming\Typora\typora-user-images\image-20210508175113515.png)

## 事件类型

| 事件             | 描述                                   |
| ---------------- | -------------------------------------- |
| ``AE_READABLE``  | 读事件，优先处理                       |
| ``AE_WRITEABLE`` | 写事件，同时存在两种事件，先处理读事件 |

## 处理器分类

| 处理器         | 监听事件         | 处理内容         |
| -------------- | ---------------- | ---------------- |
| 连接应答处理器 | ``AE_READLABLE`` | 初次连接时候应答 |
| 命令请求处理器 | ``AE_READLABLE`` | 请求命令读取     |
| 命令回复处理器 | ``AE_WRITEABLE`` | 响应结果回复     |

# 时间事件

## 事件类型

| 事件类型 | 返回值          | 内容描述           |
| -------- | --------------- | ------------------ |
| 定时事件 | ``AE_NOMORE``   | 指定时间执行，一次 |
| 周期事件 | 非``AE_NOMORE`` | 指定延迟执行，循环 |

## 事件组成

| component    | description                      |
| ------------ | -------------------------------- |
| ``id``       | 全局唯一时间事件``ID``，顺序递增 |
| ``when``     | 时间戳，记录事件到达(执行)时间   |
| ``timeProc`` | 事件处理器，执行方法             |

![image-20210508190404561](C:\Users\wenlong.guo\AppData\Roaming\Typora\typora-user-images\image-20210508190404561.png)

- 新事件插入：新创建的事件总是表头插入
- 无序列表：指的是``when``无序，无法进行时间上的调度，只能全部执行才能确保某个事件被执行

# 事件调度

```flow
start=>start: 服务器启动
close=>condition: 关闭服务器 ?
end=>end: 关闭服务器
wait=>operation: 等待文件事件产生
doFile=>operation: 处理已经产生的文件事件
doTime=>operation: 处理已到达的时间事件
start->close(yes, right)->end
close(no)->wait->doFile->doTime->close
```

- 阻塞等待文件事件产生，阻塞时间由当前最近的时间事件决定
  - 防止频繁时间事件轮询
  - 确保不会阻塞过长时间
- 阻塞处理文件事件，时间片逐渐推向后续时间事件
- 对事件处理都是同步、有序、原子的。服务器不会中途中断处理，也不会进行抢占。
  - 尽可能的减少程序阻塞时间，有必要时主动让出执行权，防止事件饥饿。
    - 耗时文件事件留待下次轮询
    - 耗时时间事件放入子线程或子进程执行
- 时间事件处理在文件事件之后，因此时间事件总是比预设的滞后一些



